<!DOCTYPE html>
<html lang="de">
<head>
  <%- include('./partials/head'); %>
</head>
<body class="bg-gradient-to-b from-gray-900 to-gray-950 min-h-screen text-white">
  <%- include('./partials/nav'); %>

  <main class="mx-auto max-w-6xl px-4 py-12">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">Aktivitäten</h1>
        <p class="mt-1 text-sm text-gray-400">Übersicht aller Aktivitäten</p>
      </div>

      <!-- Search + Create -->
      <div class="flex items-center"></div>
        <div class="relative">
          <label for="activitySearch" class="sr-only">Suche Aktivitäten</label>
          <input id="activitySearch" type="search" placeholder="Suchen"
            class="w-28 sm:w-48 text-sm rounded-md bg-white/5 border border-white/10 px-2 py-1.5 text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <button id="clearSearch" type="button" aria-label="Suche löschen"
            class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white hidden">
            ✕
          </button>
        </div>
        <a href="/activity/create" class="inline-flex items-center gap-2 rounded-md bg-indigo-500 hover:bg-indigo-400 px-4 py-2 text-sm font-semibold text-white shadow-sm">
          Neue Aktivität
        </a>
      </div>
    </div>

    <section class="bg-gray-800/60 backdrop-blur-sm rounded-2xl p-6 ring-1 ring-white/6 shadow-lg">
      <% 
        const list = (typeof activity !== 'undefined' && activity) ? activity 
                     : ((typeof activitys !== 'undefined' && activitys) ? activitys : []);
      %>

      <% if (!list || list.length === 0) { %>
        <div id="noDataStatic" class="text-center py-12">
          <p class="text-gray-300">Keine Aktivitäten vorhanden.</p>
          <a href="/activity/create" class="mt-4 inline-block rounded-md bg-indigo-500 hover:bg-indigo-400 px-4 py-2 text-sm font-semibold text-white">Erstellen</a>
        </div>
      <% } else { %>
        <div class="overflow-x-auto">
          <table id="activitysTable" class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr class="text-left">
                <th class="px-4 py-3 text-sm font-medium text-gray-300">Titel</th>
                <th class="px-4 py-3 text-sm font-medium text-gray-300 hidden sm:table-cell">Datum</th>
                <th class="px-4 py-3 text-sm font-medium text-gray-300">Zeit</th>
                <th class="px-4 py-3 text-sm font-medium text-gray-300 hidden md:table-cell">Ort</th>
                <th class="px-4 py-3 text-sm font-medium text-gray-300 hidden lg:table-cell">Abteilung</th>
                <th class="px-4 py-3 text-sm font-medium text-gray-300 text-right">Aktionen</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
              <% list.forEach(function(a){ %>
                <tr class="hover:bg-white/2" data-search="<%= [a.title, a.goal, a.location, a.departmant].filter(Boolean).join(' | ').toLowerCase() %>">
                  <td class="px-4 py-3 align-top">
                    <div class="text-sm font-semibold text-white"><%= a.title || '—' %></div>
                    <div class="text-xs text-gray-400 mt-1"><%= a.goal ? (a.goal.length > 80 ? a.goal.slice(0,80) + '…' : a.goal) : '' %></div>
                  </td>

                  <td class="px-4 py-3 align-top hidden sm:table-cell text-sm text-gray-200">
                    <%= a.date ? new Date(a.date).toLocaleDateString('de-DE') : '' %>
                  </td>

                  <td class="px-4 py-3 align-top text-sm text-gray-200">
                    <%= a.start_time || '' %><% if (a.end_time) { %> — <%= a.end_time %><% } %>
                  </td>

                  <td class="px-4 py-3 align-top hidden md:table-cell text-sm text-gray-200">
                    <%= a.location || '' %>
                  </td>

                  <td class="px-4 py-3 align-top hidden lg:table-cell text-sm text-gray-200">
                    <%= a.departmant || '' %>
                  </td>

                  <td class="px-4 py-3 align-top text-right">
                    <div class="inline-flex items-center gap-2">
                      <script>
                      (function(){
                        var td = document.currentScript.parentElement;
                        var tr = td.closest('tr');
                        if (!tr) return;
                        tr.classList.add('cursor-pointer');
                        var target = '/activity/<%= a.id %>';
                        tr.setAttribute('tabindex','0');
                        tr.setAttribute('role','link');

                        tr.addEventListener('click', function(e){
                          if (e.target.closest('a') || e.target.closest('button') || e.target.closest('form')) return;
                          window.location.href = target;
                        });

                        tr.addEventListener('keydown', function(e){
                          if (e.key === 'Enter' || e.key === ' ') {
                            if (document.activeElement && (document.activeElement.closest('a') || document.activeElement.closest('button') || document.activeElement.closest('form'))) return;
                            e.preventDefault();
                            window.location.href = target;
                          }
                        });
                      })();
                      </script>
                      <a href="/activity/update?id=<%= a.id %>" class="text-sm text-gray-300 hover:text-white px-3 py-1 rounded-md bg-white/2">Bearbeiten</a>

                      <form action="/activity/delete" method="POST" onsubmit="return confirm('Aktivität löschen?')" class="inline">
                        <input type="hidden" name="id" value="<%= a.id %>">
                        <button type="submit" class="text-sm text-red-300 hover:text-white px-3 py-1 rounded-md bg-white/2">Löschen</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>

              <!-- no results row (hidden by default) -->
              <tr id="noResultsRow" class="hidden">
                <td colspan="6" class="px-4 py-8 text-center text-gray-300">
                  Keine Aktivitäten gefunden.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>
  </main>

  <footer class="mt-12">
    <%- include('./partials/footer'); %>
  </footer>

    <script>
      (function(){
        const input = document.getElementById('activitySearch');
        const clearBtn = document.getElementById('clearSearch');
        const table = document.getElementById('activitysTable');
        if (!input || !table) return;

        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.id !== 'noResultsRow');
        const noResultsRow = document.getElementById('noResultsRow');

        function setClearVisible(visible) {
          if (!clearBtn) return;
          clearBtn.style.display = visible ? '' : 'none';
        }

        function filterRows() {
          const q = input.value.trim().toLowerCase();
          let visibleCount = 0;
          if (q === '') {
            rows.forEach(r => r.style.display = '');
            visibleCount = rows.length; // when query empty, all rows are visible
          } else {
            rows.forEach(r => {
              const hay = (r.dataset.search || '').toLowerCase();
              const ok = hay.indexOf(q) !== -1;
              r.style.display = ok ? '' : 'none';
              if (ok) visibleCount++;
            });
          }

          // show/hide no results row
          if (noResultsRow) {
            if (visibleCount === 0) {
              noResultsRow.classList.remove('hidden');
            } else {
              noResultsRow.classList.add('hidden');
            }
          }

          setClearVisible(q.length > 0);
        }

        // debounce
        let timeout;
        input.addEventListener('input', () => {
          clearTimeout(timeout);
          timeout = setTimeout(filterRows, 120);
        });

        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            input.value = '';
            filterRows();
            input.focus();
          });
        }

        // initial state
        setClearVisible(false);
      })();
    </script>
</body>
</html>